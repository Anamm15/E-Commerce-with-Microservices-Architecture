version: '3.8'

services:
  # 1. Layanan Broker Kafka
  kafka-broker:
    image: confluentinc/cp-kafka:7.6.1 # Gunakan image resmi & terbaru
    container_name: kafka-broker
    ports:
      # Port untuk diakses dari DALAM Docker network (oleh service Go Anda)
      - "9092:9092"
      # Port untuk diakses dari LUAR Docker (mis: GUI tool di laptop Anda)
      - "19092:19092"
    environment:
      # --- Konfigurasi Mode KRaft (Tanpa Zookeeper) ---
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: 'broker,controller' # Mode KRaft
      KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka-broker:9093' # Self-managed
      KAFKA_CONTROLLER_LISTENER_NAMES: 'CONTROLLER'

      # --- Konfigurasi Network & Listener ---
      KAFKA_LISTENERS: 'INTERNAL://:9092,EXTERNAL://:19092,CONTROLLER://:9093'
      KAFKA_ADVERTISED_LISTENERS: 'INTERNAL://kafka-broker:9092,EXTERNAL://localhost:19092'
      KAFKA_INTER_BROKER_LISTENER_NAME: 'INTERNAL'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: 'INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT'

      # --- Best Practice: Konfigurasi Dasar ---
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1     # Cukup 1 untuk development
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0     # Percepat rebalance saat dev
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'     # Izinkan auto-create topic

    healthcheck:
      test: ["CMD", "kafka-topics", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    networks:
      - ecomm-network # Hubungkan ke network kustom

  # 2. (Opsional) GUI untuk Mengelola Kafka
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    ports:
      - "8090:8080" # Akses UI di http://localhost:8090
    depends_on:
      kafka-broker:
        condition: service_healthy # Tunggu Kafka sehat
    environment:
      KAFKA_CLUSTERS_0_NAME: 'local-cluster'
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: 'kafka-broker:9092' # Terhubung via Docker network
      DYNAMIC_CONFIG_ENABLED: 'true'
    networks:
      - ecomm-network

# Network kustom agar semua service bisa saling "berbicara" menggunakan nama service
networks:
  ecomm-network:
    driver: bridge